{"version":3,"sources":["../src/index.ts"],"names":["path","fs","compile","server"],"mappings":"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","file":"index.cjs","sourcesContent":["import { compile, type CompileOptions, type PluginSpec } from 'lessgo';\nimport fs from 'node:fs';\nimport path from 'node:path';\nimport type { Plugin, ResolvedConfig, ViteDevServer } from 'vite';\n\n/**\n * Options for the lessgo Vite plugin\n */\nexport interface LessgoPluginOptions {\n  /**\n   * Minify CSS output\n   * @default false\n   */\n  compress?: boolean;\n\n  /**\n   * Additional include paths for @import resolution\n   * These paths will be searched when resolving @import statements\n   */\n  paths?: string[];\n\n  /**\n   * Global variables to inject into LESS compilation\n   * Variables are available in all compiled LESS files\n   * @example { theme: '\"dark\"', primaryColor: '#007bff' }\n   */\n  globalVars?: Record<string, string>;\n\n  /**\n   * Variables to modify (override) in LESS compilation\n   * These take precedence over variables defined in LESS files\n   * @example { primaryColor: '#ff0000' }\n   */\n  modifyVars?: Record<string, string>;\n\n  /**\n   * LESS plugins to load\n   * Can be plugin names (with or without 'less-plugin-' prefix),\n   * paths to plugin files, or plugin specification objects\n   * @example ['clean-css']\n   * @example [{ name: 'clean-css', options: 'advanced' }]\n   * @example ['./my-plugin.js']\n   */\n  plugins?: (PluginSpec | string)[];\n\n  /**\n   * Generate source maps\n   * @default true in development, false in production\n   */\n  sourceMap?: boolean;\n\n  /**\n   * File patterns to include\n   * @default /\\.less$/\n   */\n  include?: RegExp | string | string[];\n\n  /**\n   * File patterns to exclude\n   */\n  exclude?: RegExp | string | string[];\n}\n\n// Internal constants\nconst VIRTUAL_PREFIX = '\\0lessgo-compiled:';\nconst VIRTUAL_SUFFIX = '.css';\nconst LESS_FILE_REGEX = /\\.less$/;\nconst VIRTUAL_ID_REGEX = /^\\0lessgo-compiled:/;\n\n/**\n * Normalize a pattern to a RegExp\n */\nfunction toRegExp(pattern: RegExp | string | string[] | undefined): RegExp | null {\n  if (!pattern) return null;\n  if (pattern instanceof RegExp) return pattern;\n  if (typeof pattern === 'string') {\n    return new RegExp(pattern.replace(/[.*+?^${}()|[\\]\\\\]/g, '\\\\$&'));\n  }\n  if (Array.isArray(pattern)) {\n    const escaped = pattern.map((p) => p.replace(/[.*+?^${}()|[\\]\\\\]/g, '\\\\$&'));\n    return new RegExp(`(${escaped.join('|')})`);\n  }\n  return null;\n}\n\n/**\n * Check if a path matches include/exclude patterns\n */\nfunction shouldProcess(\n  filePath: string,\n  include: RegExp | null,\n  exclude: RegExp | null\n): boolean {\n  // Must match include pattern (or no include pattern specified)\n  if (include && !include.test(filePath)) {\n    return false;\n  }\n  // Must not match exclude pattern\n  if (exclude && exclude.test(filePath)) {\n    return false;\n  }\n  // Default: match .less files\n  return LESS_FILE_REGEX.test(filePath);\n}\n\n/**\n * Format a compile error for Vite's error overlay\n */\nfunction formatError(error: Error, filePath: string): Error {\n  const formattedError = new Error(error.message);\n  formattedError.name = 'LessgoCompileError';\n\n  // Parse line/column from lessgo error messages if available\n  // Format: \"ParseError: ... in /path/to/file.less on line X, column Y\"\n  const lineMatch = error.message.match(/on line (\\d+)/i);\n  const columnMatch = error.message.match(/column (\\d+)/i);\n\n  // Attach source location for Vite's error overlay\n  (formattedError as Error & { loc?: { file: string; line: number; column: number } }).loc = {\n    file: filePath,\n    line: lineMatch ? parseInt(lineMatch[1], 10) : 1,\n    column: columnMatch ? parseInt(columnMatch[1], 10) : 0,\n  };\n\n  return formattedError;\n}\n\n/**\n * Vite plugin for using less.go (lessc-go) as the LESS preprocessor\n *\n * This plugin intercepts .less imports and compiles them using the\n * lessgo Node.js API, providing fast LESS compilation with the Go-based compiler.\n *\n * @param options - Plugin configuration options\n * @returns Vite plugin object\n *\n * @example\n * ```ts\n * // vite.config.ts\n * import { defineConfig } from 'vite';\n * import lessgo from '@lessgo/plugin-vite';\n *\n * export default defineConfig({\n *   plugins: [\n *     lessgo({\n *       compress: true,\n *       globalVars: {\n *         primaryColor: '#007bff',\n *       },\n *     }),\n *   ],\n * });\n * ```\n */\nexport default function lessgoPlugin(options: LessgoPluginOptions = {}): Plugin {\n  // Map virtual IDs back to original .less file paths\n  const virtualToLess = new Map<string, string>();\n\n  // Track dependencies for HMR\n  const fileDependencies = new Map<string, Set<string>>();\n\n  // Resolved patterns\n  const includePattern = toRegExp(options.include);\n  const excludePattern = toRegExp(options.exclude);\n\n  // Vite config reference\n  let config: ResolvedConfig;\n  let server: ViteDevServer | undefined;\n\n  return {\n    name: 'vite-plugin-lessgo',\n    enforce: 'pre', // Run before Vite's built-in CSS handling\n\n    configResolved(resolvedConfig) {\n      config = resolvedConfig;\n    },\n\n    configureServer(devServer) {\n      server = devServer;\n    },\n\n    resolveId(source, importer) {\n      // Only process .less files\n      if (!LESS_FILE_REGEX.test(source)) {\n        return null;\n      }\n\n      // Check include/exclude patterns\n      if (!shouldProcess(source, includePattern, excludePattern)) {\n        return null;\n      }\n\n      // Resolve the actual file path\n      let resolvedPath: string;\n      if (path.isAbsolute(source)) {\n        resolvedPath = source;\n      } else if (importer) {\n        // Handle importer that might be a virtual module\n        const importerPath = importer.startsWith(VIRTUAL_PREFIX)\n          ? virtualToLess.get(importer) || importer\n          : importer;\n        resolvedPath = path.resolve(path.dirname(importerPath), source);\n      } else {\n        resolvedPath = path.resolve(source);\n      }\n\n      // Normalize the path\n      resolvedPath = path.normalize(resolvedPath);\n\n      // Create a virtual module ID ending in .css\n      const virtualId = VIRTUAL_PREFIX + resolvedPath + VIRTUAL_SUFFIX;\n      virtualToLess.set(virtualId, resolvedPath);\n\n      return virtualId;\n    },\n\n    async load(id) {\n      // Only process our virtual modules\n      if (!id.startsWith(VIRTUAL_PREFIX)) {\n        return null;\n      }\n\n      const lessPath = virtualToLess.get(id);\n      if (!lessPath) {\n        return null;\n      }\n\n      if (!fs.existsSync(lessPath)) {\n        throw new Error(`[lessgo] LESS file not found: ${lessPath}`);\n      }\n\n      try {\n        // Build include paths - always include the file's directory\n        const includePaths = [path.dirname(lessPath)];\n        if (options.paths) {\n          includePaths.push(...options.paths);\n        }\n\n        // Add node_modules paths for @import resolution\n        let currentDir = path.dirname(lessPath);\n        while (currentDir !== path.dirname(currentDir)) {\n          const nodeModules = path.join(currentDir, 'node_modules');\n          if (fs.existsSync(nodeModules)) {\n            includePaths.push(nodeModules);\n          }\n          currentDir = path.dirname(currentDir);\n        }\n\n        // Determine source map setting\n        const generateSourceMap =\n          options.sourceMap !== undefined\n            ? options.sourceMap\n            : config.command === 'serve';\n\n        // Build compile options\n        const compileOptions: CompileOptions = {\n          paths: includePaths,\n          compress: options.compress,\n          globalVars: options.globalVars,\n          modifyVars: options.modifyVars,\n          plugins: options.plugins,\n          sourceMap: generateSourceMap,\n        };\n\n        // Compile using lessgo Node.js API\n        const result = await compile(lessPath, compileOptions);\n\n        // Track this file for HMR\n        if (server) {\n          this.addWatchFile(lessPath);\n        }\n\n        // Return compiled CSS for Vite to process\n        return {\n          code: result.css,\n          map: result.map ? JSON.parse(result.map) : null,\n        };\n      } catch (error) {\n        throw formatError(error as Error, lessPath);\n      }\n    },\n\n    // Handle HMR updates\n    handleHotUpdate({ file, server }) {\n      if (!LESS_FILE_REGEX.test(file)) {\n        return;\n      }\n\n      // Find all virtual modules that depend on this file\n      const affectedModules: ReturnType<typeof server.moduleGraph.getModuleById>[] = [];\n\n      // Check if this is a main file we've compiled\n      for (const [virtualId, lessPath] of virtualToLess) {\n        if (lessPath === file) {\n          const mod = server.moduleGraph.getModuleById(virtualId);\n          if (mod) {\n            affectedModules.push(mod);\n          }\n        }\n      }\n\n      // Check if this is a dependency of any compiled file\n      for (const [mainFile, deps] of fileDependencies) {\n        if (deps.has(file)) {\n          const virtualId = VIRTUAL_PREFIX + mainFile + VIRTUAL_SUFFIX;\n          const mod = server.moduleGraph.getModuleById(virtualId);\n          if (mod) {\n            affectedModules.push(mod);\n          }\n        }\n      }\n\n      if (affectedModules.length > 0) {\n        return affectedModules.filter(Boolean) as NonNullable<\n          ReturnType<typeof server.moduleGraph.getModuleById>\n        >[];\n      }\n    },\n  };\n}\n\n// Named export for ESM\nexport { lessgoPlugin };\n\n// Re-export types from lessgo for convenience\nexport type { PluginSpec, CompileOptions } from 'lessgo';\n"]}
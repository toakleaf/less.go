# Output Differences Analysis - 2025-11-26

## Summary

After running the integration tests, there are **8 tests with output differences** (not 9 as previously documented). The `url-args` test is now passing.

**Baseline Status:**
- Unit tests: All passing
- Perfect CSS Matches: 84 (45.7%)
- Output Differences: 8 tests (4.3%)

---

## Categorization by Root Cause

### Category 1: Formatting Issues (Extra Whitespace)
These are the simplest to fix - just need to adjust CSS output formatting.

| Test | Issue |
|------|-------|
| container | Extra blank lines after closing braces in nested @container/@media |

### Category 2: Selector Bubbling/Duplication
Selector is incorrectly duplicated when bubbling through nested rules.

| Test | Issue |
|------|-------|
| detached-rulesets | `header header` instead of `header` in @media |
| directives-bubling | `.outOfMedia .outOfMedia` instead of `.outOfMedia` |
| media | `.third` instead of `.first .second .third` in nested @media |

### Category 3: @-rule Bubbling
At-rules like @font-face and @keyframes not bubbling correctly to root.

| Test | Issue |
|------|-------|
| directives-bubling | @font-face/@keyframes nested inside .onTop instead of bubbling up |

### Category 4: Import Reference Flag
The `reference` flag for imports not being respected.

| Test | Issue |
|------|-------|
| import-reference | Missing most expected output - reference rules being filtered incorrectly |
| import-reference-issues | Reference rules appearing when they shouldn't |

### Category 5: URL Path Handling
URL paths being normalized differently.

| Test | Issue |
|------|-------|
| static-urls | `"./css/..."` vs `"css/..."` - relative path prefix handling |
| urls | Missing svg-gradient, some properties missing |

---

## Detailed Analysis Per Test

### 1. container (main)
**Category:** Formatting
**Difference:** Extra blank lines after closing braces

```
Expected: "}"
Actual:   ""
         "}"
```

**Pattern:** When @container is nested inside @media (or vice versa), an extra blank line is added after the inner block's closing brace.

**Root Cause:** CSS output generation adding extra newlines for nested at-rules.

**Fix Complexity:** SIMPLE - Single location fix in CSS output generation.

**Files to Investigate:**
- Ruleset.go GenCSS or similar output method
- Container/Media directive output

---

### 2. detached-rulesets (main)
**Category:** Selector Bubbling
**Difference:** Selector duplicated in media query + wrong order

```
Expected: "  header {"
Actual:   "  header header {"
```

Also: Media query order is reversed for triple-wrapped queries:
```
Expected order: portrait + widescreen + print + tv, then portrait + widescreen + tv, then portrait + tv
Actual order:   portrait + tv, then portrait + widescreen + tv, then portrait + widescreen + print + tv
```

**Pattern:** When a detached ruleset is called inside a media query with a selector, the selector gets duplicated.

**Root Cause:** Selector context being incorrectly concatenated when evaluating detached rulesets in @media.

**Fix Complexity:** MEDIUM - Needs investigation of DetachedRuleset evaluation and selector handling.

**Files to Investigate:**
- detached_ruleset.go
- Media.go (selector handling during bubble)

---

### 3. directives-bubling (main)
**Category:** Selector Bubbling + At-Rule Bubbling + Formatting
**Differences:**
1. Extra blank lines (same as container)
2. Selector duplication: `.outOfMedia .outOfMedia` vs `.outOfMedia`
3. @font-face and @keyframes appearing INSIDE .onTop instead of bubbling to root

```
Expected:
.onTop {
  animation: "textscale";
  font-family: something;
}
@font-face {
  font-family: something;
  src: made-up-url;
}

Actual:
.onTop {
  @font-face {
    font-family: something;
    src: made-up-url;
  }
  @keyframes "textscale" { ... }
  animation: "textscale";
  font-family: something;
}
```

**Pattern:** Multiple issues in this test:
- At-rules not bubbling from inside rulesets
- Selectors being doubled in nested @supports/@media

**Root Cause:** At-rule bubbling visitor not handling all cases, selector context issue.

**Fix Complexity:** MEDIUM-HIGH - Multiple issues to address.

**Files to Investigate:**
- Directive bubbling visitor
- @supports/@document handling

---

### 4. import-reference (main)
**Category:** Import Reference Flag
**Difference:** Missing most of the expected output

```
Expected starts with: input[type="text"].class#id[attr=32]:not(1) { ... }
Actual starts with: .visible { color: red; }
```

**Pattern:** When importing with `(reference)` option, rules that should be included are being filtered out, and the output is much shorter than expected.

**Root Cause:** The `reference` flag handling during import evaluation. Reference imports should include rules only when they're extended or mixed in.

**Fix Complexity:** HIGH - Requires understanding of reference import semantics and how extends/mixins interact.

**Files to Investigate:**
- import.go
- extend visitor
- Reference flag propagation

---

### 5. import-reference-issues (main)
**Category:** Import Reference Flag
**Difference:** Reference rules appearing when they shouldn't

```
Expected: .test-rule-c { background-color: green; }
Actual: .test-rule-c { color: red; }
        .test-rule-c { background-color: green; }
```

**Pattern:** Rules from reference imports appearing in output when they shouldn't.

**Root Cause:** Same as import-reference - reference flag not being respected correctly.

**Fix Complexity:** HIGH - Same underlying issue as import-reference.

---

### 6. urls (main)
**Category:** URL Path Handling
**Difference:** Missing svg-gradient, different import path

```
Expected line 4: .gray-gradient { background: url('data:image/svg+xml,...'); }
Actual line 4: .gray-gradient { background: url(...); }  // Different/missing SVG
```

Also missing properties and different data-uri handling.

**Pattern:** Complex URL handling differences in:
- SVG gradient generation
- Data URI encoding
- Relative path resolution

**Root Cause:** URL function evaluation, possibly svg-gradient function.

**Fix Complexity:** MEDIUM - Need to check URL processing and data-uri function.

**Files to Investigate:**
- url.go
- data-uri function
- svg-gradient function

---

### 7. static-urls (static-urls suite)
**Category:** URL Path Handling
**Difference:** Relative path prefix

```
Expected: @import "./css/background.css";
Actual:   @import "css/background.css";
```

**Pattern:** The `./` prefix is missing from relative import paths.

**Root Cause:** staticUrls option handling or path normalization.

**Fix Complexity:** SIMPLE - Path formatting adjustment.

**Files to Investigate:**
- Import path resolution
- staticUrls option handling

---

### 8. media (main)
**Category:** Selector Bubbling
**Difference:** Missing parent selectors in nested media

```
Expected: .first .second .third { color: green; }
Actual:   .third { color: green; }
```

**Pattern:** When media queries are nested deeply, the parent selectors are lost.

**Root Cause:** Selector context not being properly accumulated when bubbling media queries.

**Fix Complexity:** MEDIUM - Similar to directives-bubling selector issue.

**Files to Investigate:**
- Media.go
- Selector bubbling logic

---

## Priority Order for Fixes

### Quick Wins (Fix First)
1. **static-urls** - Simple path prefix fix
2. **container** - Simple whitespace formatting fix

### Medium Effort (Related Issues - Fix Together)
3. **media + directives-bubling + detached-rulesets** (Selector Bubbling)
   - These share the same root cause: selector context during at-rule bubbling
   - Fix one, likely fixes the others

4. **directives-bubling** (At-Rule Bubbling)
   - @font-face/@keyframes not bubbling correctly

### Higher Effort
5. **urls** - URL/data-uri handling
   - More investigation needed

6. **import-reference + import-reference-issues** (Import Reference)
   - Complex semantics around reference imports
   - Highest effort, should be tackled last

---

## Recommended Agent Assignment

| Priority | Test(s) | Estimated Complexity | Agent Type |
|----------|---------|---------------------|------------|
| 1 | static-urls | SIMPLE | Single agent, quick fix |
| 2 | container | SIMPLE | Single agent, quick fix |
| 3 | media, detached-rulesets, directives-bubling | MEDIUM | Single agent, related fixes |
| 4 | urls | MEDIUM | Single agent |
| 5 | import-reference, import-reference-issues | HIGH | Dedicated agent |

---

## Files Likely Needing Changes

1. **CSS Output Generation** (container, formatting issues)
2. **Media.go** - Selector bubbling for media queries
3. **Directive.go** - @supports/@document bubbling
4. **DetachedRuleset.go** - Selector handling when called in media
5. **Import.go** - Reference flag handling
6. **URL.go** - Path normalization, data-uri
